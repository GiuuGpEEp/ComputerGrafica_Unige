**Tappa 12 Progetto**

Questa tappa introduce: condizioni di vittoria/sconfitta, polish di battaglia, fondamenti di Posizionamento/Set integrati ai tributi, e una bozza robusta di sistema effetti.

**Win/Lose e Deck-out**
Un giocatore vince quando l’avversario:
- scende a 0 Life Points; oppure
- deve pescare ma non ha carte nel Deck (deck-out).

Modifiche in `Game`:
- Flag `gameOver` e getter; indice `winnerIndex` e getter.
- `dealDamageTo()` emette `LifePointsChanged` e verifica la vittoria (`Win`/`Lose`).
- `handleDeckOutIfAny()` controlla sia il Deck logico del Player, sia il Deck dell’UI collegato via `attachExternalDeck(&deck)` per evitare desincronizzazioni con l’animazione di pesca.
- Salto pescata del primissimo turno per il giocatore iniziale.

GUI (main):
- Overlay di Game Over con input gating; SPACE per tornare alla Home.
- Subscribers agli eventi `Win`/`Lose` per attivare l’overlay.

**Battaglia – micro-polish**
- Indicatore “ha già attaccato” (pallino rosso) sui mostri che hanno attaccato; blocco selezione degli stessi.
- Eventi di battaglia (`AttackDeclared`, `AttackResolved`, `DirectAttack`) già emessi per wiring UI/effetti.
- Nuova regola: i mostri in Difesa o coperti non possono dichiarare attacchi.

Altre zone/stato:
- Graveyard separato per ciascun giocatore; aggiunta la zona `Banished` (helper `banishFrom`).

**Posizionamento dei mostri (Set) integrato con i Tributi**
Nel gioco ufficiale, durante la Normal Summon si può:
- Evocare in Attacco scoperto; oppure
- Posizionare (Set): carta coperta in posizione di Difesa; conta come Normal Summon del turno.

Modifiche in `Game`:
- Nuovo evento `NormalSet`.
- Stato per posizione per ciascun mostro: `monsterIsDefense`, `monsterIsFaceDown` (allineati a `monsterZones`).
- Nuove API:
	- `bool tryNormalSet(size_t handIndex)` – come `tryNormalSummon`, ma posiziona DEF coperto; richiede gli stessi tributi dei mostri alti.
	- `bool setPosition(size_t zoneIndex, bool defense, bool faceDown=false)`.
	- `bool isDefenseAt(int playerIdx, size_t zoneIndex) const`, `bool isFaceDownAt(...) const`.
- Tributi: overload `beginNormalSummonWithTributes(size_t handIndex, bool asSet)` memorizza l’intento; `completePendingNormalSummon` evoca o setta in base a tale flag e emette `NormalSummon` o `NormalSet`.
- Coerenza vettori: allineamento di flag posizione e attacco su `moveCard`, `destroyMonster`, `tributeMonsters`.
- Attacchi: `canDeclareAttack` ora blocca se il mostro è in Difesa o coperto.

GUI (main):
- Quando si droppa una carta su uno slot valido, appare una scelta rapida: premi `E` per Evocazione, `P` per Posizionamento. Se servono tributi parte il flusso di selezione e, a fine tributi, la carta viene evocata o settata in base alla scelta.
- Subscribe a `NormalSet` (oltre a `NormalSummon` e `MonstersTributed`) per sincronizzare il render del campo.

**Bozza sistema Effetti (revisione)**
- Interfaccia minimale `ICardEffect` con `onEvent(GameEventType, Game&)`.
- `EffectSystem`: registry per nome carta → effetto; `registerEffectForCardName` per registrare.
- Dispatch centralizzato: nel costruttore di `Game` sono state aggiunte subscription agli eventi di gioco (DrawStart/End, NormalSummon, MonstersTributed, CardSentToGrave, LifePointsChanged, DirectAttack, TurnEnd, Win/Lose, ecc.) che inoltrano verso `EffectSystem::dispatch`. Rimosse le chiamate manuali a `dispatchEffects` sparse post-emit.
- Sicurezza dispatch:
	- Snapshot dei nomi delle carte sul campo prima di iterare (evita invalidazioni se gli effetti modificano lo stato).
	- Guard anti-reentrancy (`dispatching`) per prevenire loop ricorsivi.
- Build system: aggiunto `Game/Effects/EffectSystem.cpp` al target CMake; distruttore definito out-of-line per risolvere i warning su tipo incompleto.

Prossimi passi (idee):
- Rendering retro carta per i mostri coperti e una tinta per la Difesa; shortcut `D/F` per cambiare posizione (dove consentito dalle regole).
- Payload eventi per gli effetti (attacker/target/amount/zone) e semplice chain window sugli eventi chiave.

