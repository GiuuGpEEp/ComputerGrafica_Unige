**Tappa 13 – Magie e Trappole (engine + UI + build)**

Questa tappa introduce il sistema di Magie/Trappole (M/T): zone dedicate, slot Magia Terreno, regole di set/attivazione, eventi e API del `Game`.

## Obiettivi
- Zone M/T per entrambi i giocatori con 3 slot ciascuna.
- Slot esclusivo per Magia Terreno per ogni giocatore (sostituzione invia la precedente al Cimitero).
- Regole di attivazione conformi al minimo richiesto:
	- Trappole: non si attivano dalla mano; vanno settate; non attivabili nel turno in cui sono state settate; (prossimo step) attivabili nel turno avversario.
	- Magie Normali/Rituali: attivabili dalla mano; possono anche essere settate e attivate subito.
	- Magie Rapide: attivabili dalla mano; se settate non attivabili nello stesso turno; (prossimo step) utilizzabili nel turno avversario.
	- Magie Continue: restano sul campo dopo l’attivazione.
	- Magie Terreno: vanno nello slot dedicato e restano attive.

## Cambi principali al codice

### Game
File: `GameLogic/Game/Game.h` e `GameLogic/Game/Game.cpp`.

- Nuove zone e stato:
	- `spellTraps[2]`: carte M/T sul campo (3 slot per giocatore).
	- `stIsFaceDown[2]`: true se la carta M/T nello slot è coperta.
	- `stSetThisTurn[2]`: true se la carta è stata settata in questo turno del proprietario (vincolo di timing).
	- `fieldSpell[2]`: slot opzionale per Magia Terreno (una per giocatore).
- Nuove API M/T:
	- `bool setSpellOrTrap(size_t handIndex);`
	- `bool setFieldSpell(size_t handIndex);`
	- `bool activateSpellFromHand(size_t handIndex);` (blocca Trappole dalla mano; Continue restano sul campo; Terreno usa slot dedicato)
	- `bool activateSetSpellTrap(size_t zoneIndex);` (blocca attivazione nello stesso turno del set per Trappole e Rapide)
	- Query: `isSpellTrapFaceDownAt`, `isSpellTrapSetThisTurnAt`.
- Integrazione turno/fasi:
	- In `startTurn()` si azzera `stSetThisTurn` per il giocatore corrente, abilitando l’attivazione delle carte settate in turni precedenti.
- `moveCard(...)` esteso a `SpellTrapZone` con mantenimento dei flag e blocco su `FieldSpellZone` (usa API dedicate).

### Eventi
File: `GameLogic/Events/EventDispatcher.h`.

- Aggiunti tipi evento per M/T:
	- `SpellSet`, `TrapSet`, `SpellActivated`, `TrapActivated`.
	- Eventi esistenti riutilizzati: `CardMoved`, `CardSentToGrave`.

### Build
File: `CMakeLists.txt`.

- Aggiunto target `mainTappa13` (simile a Tappa 12). L’eseguibile viene generato in `build/bin/mainTappa13.exe`.

## Stato funzionale (v1.2)
- Regole coperte:
	- Trappole: set obbligatorio; no attivazione nello stesso turno del set.
	- Magie Normali/Rituali: attivabili dalla mano; set+attivazione immediata consentita.
	- Magie Rapide: dalla mano sì; se settate non attive lo stesso turno.
	- Magie Continue: restano sul campo; vengono messe scoperte nella zona M/T.
	- Magie Terreno: slot dedicato; la precedente viene mandata al Cimitero.
- UI collegata in `main.cpp`:
	- Drag&drop dalla mano verso zona M/T e slot Terreno con prompt di scelta.
	- Attivazione da mano (A) o Set (S) per Magie/Trappole; Mostri con Evoca (E) o Posiziona (P).
	- Attivazione da coperta con tasto rapido (X) su carta sotto il mouse.
	- Rendering coperta/scoperta per M/T e slot Campo per entrambi i lati.
- Da completare (next):
	- Catene/priority avanzate e limitazioni di fase più precise per la risposta.

## API di riferimento (estratto)
- `bool setSpellOrTrap(size_t handIndex);`
- `bool setFieldSpell(size_t handIndex);`
- `bool activateSpellFromHand(size_t handIndex);`
- `bool activateSetSpellTrap(size_t zoneIndex);`
- `bool activateSetSpellTrapFor(int playerIdx, size_t zoneIndex);` (attiva una M/T settata per un giocatore assoluto; usato per la risposta nel turno avversario)
 - `bool isSpellTrapFaceDownAt(int playerIdx, size_t zoneIndex) const;`
- `bool isSpellTrapSetThisTurnAt(int playerIdx, size_t zoneIndex) const;`
 - `std::optional<Card> getFieldSpellOf(int playerIdx) const;` (getter per lo slot Campo)

## UI e controlli
- Trascinamento dalla mano:
	- Se la carta è Magia/Trappola: trascina su zona M/T o slot Campo → appare un prompt “Magia/Trappola: A = Attiva, S = Setta”.
		- A = attiva dalla mano (le Field vanno nello slot Campo; le Trappole non possono attivare dalla mano).
		- S = setta coperta (Trappole sempre; Rapide settate non attivabili nello stesso turno; Field va nello slot Campo e rimpiazza la precedente mandandola al Cimitero).
	- Se la carta è un Mostro: trascina su uno slot Mostro → “E = Evoca, P = Posiziona”.
- Attivazione da coperta:
	- Nel tuo turno: premi X con il mouse sopra una tua carta coperta nella zona M/T per tentare l’attivazione (`activateSetSpellTrap`).
	- Nel turno avversario: premi R per aprire la "finestra di risposta"; mentre è attiva puoi premere X su una tua M/T per provare ad attivare Trappole o Magie Rapide (non settate in quel turno).
- Altri controlli:
	- C = cambia posizione del mostro selezionato secondo le regole (flip da coperta a scoper­ta in ATK, ATK↔DEF con limiti di turno).
- Note di rendering:
	- Le carte M/T coperte usano la texture retro, le scoperte usano `Card::originalTexturePath`.
	- Lo slot Campo mostra la Field Spell attiva per ciascun giocatore.

## Come eseguire
Eseguibile: `mainTappa13`.

Se usi CMake Tools in VS Code: seleziona il target `mainTappa13` e lancia. In alternativa da terminale PowerShell:

```powershell
cmake --build "${env:USERPROFILE}\Documents\Università\TerzoAnno\SecondoSemestre\FCG\Progetto\build" --config Release
"${env:USERPROFILE}\Documents\Università\TerzoAnno\SecondoSemestre\FCG\Progetto\build\bin\mainTappa13.exe"
```

## Prossimi passi
- Implementare la finestra di risposta per attivazioni nel turno avversario.
- Eventuali rifiniture UI (feedback, highlight, tutorial) e screenshot di esempio.
- Documentare esempi d’uso e casi limite nel README con screenshot.

