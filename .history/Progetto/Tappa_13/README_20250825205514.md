**Tappa 13 – Magie e Trappole (engine + UI + build)**

Questa tappa introduce il sistema di Magie/Trappole (M/T): zone dedicate, slot Magia Terreno, regole di set/attivazione, eventi e API del `Game`.

## Obiettivi
- Zone M/T per entrambi i giocatori con 3 slot ciascuna.
- Slot esclusivo per Magia Terreno per ogni giocatore (sostituzione invia la precedente al Cimitero).
- Regole di attivazione conformi al minimo richiesto:
	- Trappole: non si attivano dalla mano; vanno settate; non attivabili nel turno in cui sono state settate; (prossimo step) attivabili nel turno avversario.
	- Magie Normali/Rituali: attivabili dalla mano; possono anche essere settate e attivate subito.
	- Magie Rapide: attivabili dalla mano; se settate non attivabili nello stesso turno; (prossimo step) utilizzabili nel turno avversario.
	- Magie Continue: restano sul campo dopo l’attivazione.
	- Magie Terreno: vanno nello slot dedicato e restano attive.

## Cambi principali al codice

### Game
File: `GameLogic/Game/Game.h` e `GameLogic/Game/Game.cpp`.

- Nuove zone e stato:
	- `spellTraps[2]`: carte M/T sul campo (3 slot per giocatore).
	- `stIsFaceDown[2]`: true se la carta M/T nello slot è coperta.
	- `stSetThisTurn[2]`: true se la carta è stata settata in questo turno del proprietario (vincolo di timing).
	- `fieldSpell[2]`: slot opzionale per Magia Terreno (una per giocatore).
- Nuove API M/T:
	- `bool setSpellOrTrap(size_t handIndex);`
	- `bool setFieldSpell(size_t handIndex);`
	- `bool activateSpellFromHand(size_t handIndex);` (blocca Trappole dalla mano; Continue restano sul campo; Terreno usa slot dedicato)
	- `bool activateSetSpellTrap(size_t zoneIndex);` (blocca attivazione nello stesso turno del set per Trappole e Rapide)
	- Query: `isSpellTrapFaceDownAt`, `isSpellTrapSetThisTurnAt`.
- Integrazione turno/fasi:
	- In `startTurn()` si azzera `stSetThisTurn` per il giocatore precedente (quello che ha appena concluso il turno), così una Trap/Magia Rapida settata nel proprio turno diventa attivabile già nel turno successivo dell’avversario.
- `moveCard(...)` esteso a `SpellTrapZone` con mantenimento dei flag e blocco su `FieldSpellZone` (usa API dedicate).

### Eventi
File: `GameLogic/Events/EventDispatcher.h`.

- Aggiunti tipi evento per M/T:
	- `SpellSet`, `TrapSet`, `SpellActivated`, `TrapActivated`.
	- Eventi esistenti riutilizzati: `CardMoved`, `CardSentToGrave`.

### Build
File: `CMakeLists.txt`.

- Aggiunto target `mainTappa13` (simile a Tappa 12). L’eseguibile viene generato in `build/bin/mainTappa13.exe`.

## Stato funzionale (v1.1)
- Regole coperte:
	- Trappole: set obbligatorio; no attivazione nello stesso turno del set.
	- Magie Normali/Rituali: attivabili dalla mano; set+attivazione immediata consentita.
	- Magie Rapide: dalla mano sì; se settate non attive lo stesso turno.
	- Magie Continue: restano sul campo; vengono messe scoperte nella zona M/T.
	- Magie Terreno: slot dedicato; la precedente viene mandata al Cimitero.
- UI collegata in `main.cpp`:
	- Drag&drop dalla mano verso zona M/T e slot Terreno con prompt di scelta.
	- Attivazione da mano (A) o Set (S) per Magie/Trappole; Mostri con Evoca (E) o Posiziona (P).
	- Attivazione da coperta con tasto rapido (X) su carta sotto il mouse.
	- Rendering coperta/scoperta per M/T e slot Campo per entrambi i lati.
Da completare (next):
	- Migliorare la finestra di risposta (stack/catena, priorità, timing più precisi) e l’evidenziazione delle carte attivabili.

## API di riferimento (estratto)
- `bool setSpellOrTrap(size_t handIndex);`
- `bool setFieldSpell(size_t handIndex);`
- `bool activateSpellFromHand(size_t handIndex);`
- `bool activateSetSpellTrap(size_t zoneIndex);`
 - `bool isSpellTrapFaceDownAt(int playerIdx, size_t zoneIndex) const;`
- `bool isSpellTrapSetThisTurnAt(int playerIdx, size_t zoneIndex) const;`
 - `std::optional<Card> getFieldSpellOf(int playerIdx) const;` (getter per lo slot Campo)

## UI e controlli
- Trascinamento dalla mano:
	- Se la carta è Magia/Trappola: trascina su zona M/T o slot Campo → appare un prompt “Magia/Trappola: A = Attiva, S = Setta”.
		- A = attiva dalla mano (le Field vanno nello slot Campo; le Trappole non possono attivare dalla mano).
		- S = setta coperta (Trappole sempre; Rapide settate non attivabili nello stesso turno; Field va nello slot Campo e rimpiazza la precedente mandandola al Cimitero).
	- Se la carta è un Mostro: trascina su uno slot Mostro → “E = Evoca, P = Posiziona”.
- Attivazione da coperta:
	- Premi X con il mouse sopra una tua carta coperta nella zona M/T per tentare l’attivazione (`activateSetSpellTrap`).
- Altri controlli:
	- C = cambia posizione del mostro selezionato secondo le regole (flip da coperta a scoper­ta in ATK, ATK↔DEF con limiti di turno).
- Note di rendering:
	- Le carte M/T coperte usano la texture retro, le scoperte usano `Card::originalTexturePath`.
	- Lo slot Campo mostra la Field Spell attiva per ciascun giocatore.

## Come eseguire
Eseguibile: `mainTappa13`.

Se usi CMake Tools in VS Code: seleziona il target `mainTappa13` e lancia. In alternativa da terminale PowerShell:

```powershell
cmake --build "${env:USERPROFILE}\Documents\Università\TerzoAnno\SecondoSemestre\FCG\Progetto\build" --config Release
"${env:USERPROFILE}\Documents\Università\TerzoAnno\SecondoSemestre\FCG\Progetto\build\bin\mainTappa13.exe"
```

## Prossimi passi
- Eventuali rifiniture UI (feedback, highlight, tutorial) e screenshot di esempio.
- Documentare esempi d’uso e casi limite nel README con screenshot.


## Aggiornamenti recenti (25/08/2025) — dettagli per file e motivazioni

Elenco delle modifiche introdotte dopo l’ultimo aggiornamento del README, con spiegazioni per file, metodi e flag.

### GameLogic/Game/Game.h e GameLogic/Game/Game.cpp

- Timing set/attivazione M/T: reset `stSetThisTurn` corretto
	- Modifica: in `startTurn()` si pulisce `stSetThisTurn` del giocatore precedente, non quello corrente.
	- Motivo: rendere attivabili Trap/Magie Rapide settate nel proprio turno già dal turno avversario successivo.

- API di attivazione M/T settate (incluso turno avversario):
	- `bool activateSetSpellTrap(size_t zoneIndex);`
		- Alias per il giocatore di turno; inoltra a `activateSetSpellTrapFor(cur, zoneIndex)`.
	- `bool activateSetSpellTrapFor(int playerIdx, size_t zoneIndex);`
		- Attiva una M/T settata per un giocatore assoluto (0/1). Regole:
			- Proprio turno: solo in Main1/Main2; se `stSetThisTurn==true` e (Trap o Magia Rapida) → non attivabile.
			- Turno avversario: solo Trap o Magie Rapide; se `stSetThisTurn==true` → non attivabile.
		- Flusso: `canActivate` dell’effetto, scoperta carta (`stIsFaceDown=false`), evento `TrapActivated`/`SpellActivated`, risoluzione; se non-Continua, invio al Cimitero con rimozione voci parallele.
	- `bool canActivateSetSpellTrapFor(int playerIdx, size_t zoneIndex);`
		- Controllo a secco con lo stesso gating di cui sopra.
	- Query: `isSpellTrapFaceDownAt`, `isSpellTrapSetThisTurnAt`.

- Stato e flag M/T:
	- `spellTraps[2]`: zona M/T per giocatore.
	- `stIsFaceDown[2]`: copertura M/T.
	- `stSetThisTurn[2]`: marcatura di set nel turno del proprietario; sblocco dal turno successivo via reset in `startTurn()`.
	- `fieldSpell[2]`: slot Field Spell.

- Allineamento strutture:
	- `moveCard(...)`: quando si rimuove/aggiunge in `SpellTrapZone`, si mantengono allineati `stIsFaceDown` e `stSetThisTurn`.

- Eventi:
	- Emessi `TrapActivated`/`SpellActivated` all’attivazione; `CardSentToGrave` quando la carta non-Continua va al Cimitero.

- Scelte effetto (infrastruttura):
	- Special Summon con scelta posizione: `requestSpecialSummonWithChoice`, `resolvePendingSpecialSummon`; evento `SpecialSummonChoiceRequested` e stato `pendingSS`.
	- Invio dal Deck: `requestSendFromDeck`, `resolvePendingSendFromDeck`, `cancelPendingSendFromDeck`; evento `DeckSendChoiceRequested` e stato `pendingSend`.
	- Mirroring Deck UI: `mirrorExternalDeckRemoveByName` per allineare la pila visiva quando il Deck logico viene modificato da effetti.

- Altri flag (rilevanti per regole/UX):
	- `monsterHasAttacked`, `monsterIsDefense`, `monsterIsFaceDown`, `monsterSummonedThisTurn`, `monsterPositionChangedThisTurn`.

Motivazioni principali:
- Correttezza delle regole di attivazione “dal turno successivo”.
- Supporto all’attivazione nel turno avversario tramite API “For”.
- Hooks evento per UI e sistema effetti.
- Flussi modali lato UI (scelte) garantiti da stati pending.

### Progetto/Tappa_13/main.cpp

- Prompt di risposta (turno avversario) per Trap/Magie Rapide:
	- Stato: `responsePromptActive`, `responseOwner` (0/1), `responseActivables` (lista attivabili), `responseSelected` (indice selezione).
	- Apertura automatica su finestre di timing base (TurnStart, avanzamenti fase, AttackDeclared) con rebuild lista via `canActivateSetSpellTrapFor`.
	- Navigazione: frecce su/giù; Invio per attivare (chiama `activateSetSpellTrapFor`); ESC per chiudere.
	- Modal: mentre è aperto vengono bloccati avanzamenti fase, attacchi, drag&drop, toggle posizione, attivazioni rapide e input pending; annulla drag corrente all’apertura.
	- Aggiornamento live: alla ricezione di `SpellActivated`/`TrapActivated` si ricostruisce la lista; se vuota, chiude.

- Hotkey e gating:
	- `X` per attivazioni da coperta nel proprio turno; tutte le azioni soggette a guardia `!responsePromptActive`.

Motivo: UX coerente e davvero modale quando esiste una finestra di risposta.

### Progetto/Tappa_13/Deck/Deck.h e Deck/Deck.cpp

- Utilità per rimozione/ricerca dal Deck:
	- `removeFirstByName`, `findFirst`, `collectWhere` per supportare overlay e risoluzioni effetto.

- Coerenza visiva:
	- `resetDeckCardPositions` riallinea pila e texture retro; `resetAnimation` per ri-fade.
	- Shuffle avanzato: `startShuffleAnimationAdvanced`, `updateShuffleAnimationAdvanced`, `drawShuffleAnimationAdvanced`, `clearShuffleAnimationAdvanced`, `isShuffleAnimationAdvancedFinished`.

Motivo: supporto a effetti deck-driven e UI consistente.

### Bugfix e rifiniture

- Battaglia: marcatura “ha attaccato” all’inizio della dichiarazione per evitare blocchi quando il primo attaccante si autodistrugge.
- Cache M/T: pulizia su reset/nuova partita per evitare texture residue dopo rientri.

