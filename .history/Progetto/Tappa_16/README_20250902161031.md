## Tappa 16 — Implementazione degli effetti mancanti

Questa tappa integra e rifinisce diversi effetti del deck Blue-Eyes e la relativa UX.

### Novità principali
- Finestra di risposta/chain (da Tappa 15, rifinita):
	- Si apre automaticamente su eventi rilevanti (evocazioni, attacchi, ecc.).
	- Mostra solo le carte attivabili del giocatore locale (P1) e si chiude prima dei pannelli modali.
	- La chain risolve LIFO; il Pass chiude la chain quando tutti passano.
- Regola di attivazione M/T: una Trappola Continua non può essere riattivata se è già scoperta.

### Effetti implementati/rifiniti

1) La Melodia del Drago che si Risveglia
- Attivazione consentita se il proprietario ha almeno 1 carta in mano da scartare e nel Deck almeno un Drago con ATK ≥ 3000 e DEF ≤ 2500.
- Flusso interattivo:
	- P1 (umano): seleziona una carta in mano da scartare cliccandola; si apre il pannello di scelta dal Deck filtrato (Draghi 3000/2500).
	- È possibile aggiungere fino a 2 carte alla mano nella stessa risoluzione; il pannello resta aperto per la seconda scelta. ESC termina la selezione anticipatamente.
	- P2 (AI): scarta casualmente una carta dalla mano, poi sceglie casualmente i bersagli validi dal Deck.
- UX: il pannello mostra un titolo dedicato per l’aggiunta in mano e un hint che indica la possibilità di fare due scelte.

2) Richiamo del Posseduto (semplificato)
- Attivazione consentita se il proprietario ha almeno un Mostro nel proprio Cimitero e spazio libero in zona Mostri.
- Flusso interattivo al momento dell’attivazione:
	- P1 (umano): si apre un pannello di scelta che mostra solo i Mostri nel proprio Cimitero con titolo “Scegli il mostro da evocare”. Dopo la selezione, il Mostro viene Evocato Specialmente in Posizione di Attacco (scoperta).
	- P2 (AI): seleziona casualmente un Mostro dal proprio Cimitero e lo evoca.
- Nota: il comportamento “link” della Continua (distruggere il Mostro se la Trappola lascia il Terreno) è marcato come follow-up e non è ancora implementato in questa tappa.

3) Rivali Predestinati (semplificato)
- Effetto di negazione a durata turno gestito tramite helper sul Game; integrato nel sistema eventi/chain.

### Migliorie UI/UX e rendering
- Pannelli modali: si chiude sempre il prompt di risposta prima di aprirli, per evitare interferenze con i click.
- Pannello riuso e mappatura indici: lo stesso overlay di scelta è riutilizzato per Deck e Cimitero; quando la lista mostrata è filtrata (es. solo Mostri), viene gestita una mappatura indici UI → sorgente reale per risolvere correttamente la scelta.
- Carte in mano: rendering con texture frontali corrette e mantenimento della dimensione originale dopo lo swap di texture.

### Dettagli tecnici e API aggiunte

Modifiche principali a livello di codice (file e metodi chiave):

- GameLogic/Game/Game.h, Game.cpp
	- Nuovo flusso “pendente” per le scelte dal Cimitero (Richiamo del Posseduto):
		- bool requestSelectFromGraveyard(int ownerIdx)
		- bool resolvePendingSelectFromGraveyard(size_t indexInOwnerGY)
		- void cancelPendingSelectFromGraveyard()
		- std::optional<int> getPendingGraveyardOwner() const
		- bool hasPendingGraveyardChoice() const
	- Flusso Melodia già esistente, riutilizzato e rifinito:
		- bool requestHandDiscard(int ownerIdx)
		- bool resolvePendingHandDiscard(size_t handIndex)
		- void setMelodiaAddsRemaining(int n)  // consente 2 aggiunte
		- void setNextAddFromDeckAfterDiscard(int ownerIdx)  // avvia la scelta dal Deck post-scarto
		- bool hasPendingAddFromDeck() const, bool resolvePendingAddFromDeck(size_t idx)
	- Invocazione evocazione speciale (semplificata):
		- bool requestSpecialSummonWithChoice(int ownerIdx, const Card& c)
		- bool resolvePendingSpecialSummon(bool toDefense)
	- Catena/Prompt risposta: helper per passare la priorità, verifica attivazioni e gating attivazione da M/T solo se faccia in giù.

- GameLogic/Events/EventDispatcher.h
	- Aggiunto l’evento GameEventType::GraveyardChoiceRequested per aprire l’overlay di scelta dal Cimitero.

- GameLogic/Game/Effects/cards/BluEyes/LaMelodiaDelDragoCheSiRisveglia/LaMelodiaDelDragoCheSiRisvegliaEffect.cpp
	- resolve():
		- requestHandDiscard(ownerIdx)
		- setMelodiaAddsRemaining(2)
		- setNextAddFromDeckAfterDiscard(ownerIdx)

- GameLogic/Game/Effects/cards/BluEyes/RichiamoDelPosseduto/RichiamoDelPossedutoEffect.cpp
	- resolve():
		- sostituito l’auto-pick con requestSelectFromGraveyard(ownerIdx) per attivare la scelta interattiva.

- Progetto/Tappa_16/AppHandlers/AppHandlers.h, AppHandlers.cpp
	- Context: nuovo campo setDeckSendIndexMap(std::function<void(const std::vector<size_t>&)>) per passare alla UI la mappatura indici UI → indici reali della sorgente (Cimitero).
	- Nuovo handler per GameEventType::GraveyardChoiceRequested:
		- P2 (AI): selezione casuale tra i mostri nel Cimitero e risoluzione immediata via resolvePendingSelectFromGraveyard.
		- P1 (umano): riapre l’overlay di lista (riusato) con candidati filtrati ai soli Mostri, fornendo anche la mappatura indici.
	- DeckAddChoiceRequested / DeckSendChoiceRequested: chiusura prompt risposta, apertura overlay e auto-pick per AI.

- Progetto/Tappa_16/GameWiring/GameWiring.h, GameWiring.cpp
	- setupAppHandlers(...): aggiunto parametro setDeckSendIndexMap e relativo wiring in AppHandlers::Context.

- Progetto/Tappa_16/main.cpp
	- Overlay unico riusato per invio dal Deck, aggiunta dal Deck e scelta dal Cimitero:
		- Stato: deckSendChoiceActive, deckSendCandidates, deckSendSelected, deckSendOwner.
		- Nuovo vettore deckSendIndexMap per mappare l’indice UI su quello reale (necessario per il Cimitero filtrato ai soli Mostri).
		- Conferma: se hasPendingGraveyardChoice(), mappa l’indice selezionato attraverso deckSendIndexMap prima di chiamare resolvePendingSelectFromGraveyard().
	- Titoli contestuali dell’overlay:
		- Melodia: “Scegli un Mostro Drago dal Deck da aggiungere alla mano”.
		- Richiamo: “Scegli il mostro da evocare”.
	- Prompt risposta: apertura/chiusura coordinata con gli overlay; ESC effettua pass locale e auto-pass AI per permettere la risoluzione in demo.

- Progetto/Tappa_16/Utils/RenderUtils.h
	- drawDeckSendOverlay(..., titleOverride, hintOverride): aggiunta possibilità di personalizzare titolo e hint; default rimane per il caso "mandare al Cimitero".

### File toccati (riepilogo sintetico)
- GameLogic/Game/Game.h, Game.cpp — nuove API per scelte dal Cimitero e affinamenti flussi pendenti; gating attivazioni da M/T faccia in giù.
- GameLogic/Events/EventDispatcher.h — nuovo evento GraveyardChoiceRequested.
- GameLogic/Game/Effects/.../LaMelodiaDelDragoCheSiRisvegliaEffect.cpp — richiesta scarto + doppia aggiunta dal Deck.
- GameLogic/Game/Effects/.../RichiamoDelPossedutoEffect.cpp — scelta interattiva dal Cimitero.
- AppHandlers/AppHandlers.h, .cpp — nuovo campo setDeckSendIndexMap e gestore evento GY; auto-pick AI.
- GameWiring/GameWiring.h, .cpp — estensione firma setupAppHandlers con setDeckSendIndexMap.
- main.cpp — overlay unificato, mappatura indici, titoli contestuali, chiusura prompt prima delle modali.
- Utils/RenderUtils.h — overlay parametrico con title/hint override.

### Controlli rapidi
- Overlay di scelta (Deck/Cimitero):
	- Invio = Conferma la selezione corrente
	- ESC = Annulla / termina la selezione (per Melodia, chiude dopo la 1ª scelta se non si desidera la 2ª)
	- Frecce o Click = Cambia selezione
- Scarto dalla mano (Melodia): clicca la carta in mano da scartare quando richiesto.
- Prompt di risposta (chain): seleziona una carta attivabile e conferma; ESC passa la priorità (auto-pass dell’AI per risolvere la chain in demo).

### Comportamento dell’AI (P2)
- Scelte casuali per: scarto dalla mano, aggiunta dal Deck con Melodia, invio dal Deck (reliquiari/draghi), e selezione dal Cimitero con Richiamo del Posseduto.

### Limitazioni e prossimi passi
- Richiamo del Posseduto: non è ancora attivo il legame continuo “se la Trappola lascia il Terreno, distruggi quel Mostro”.
- Testi del pannello: alcuni hint sono generici e possono essere ulteriormente personalizzati per ogni effetto.

### Note di build/esecuzione
- Target: `mainTappa16` (vedi cartella `build/bin`).